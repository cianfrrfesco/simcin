<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulazione Storia del Cinema - Unicatt</title>
    <style>
        :root { --primary: #800000; --secondary: #f4f4f4; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; max-width: 800px; margin: 0 auto; padding: 20px; background: #fafafa; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1 { color: var(--primary); text-align: center; }
        .question-text { font-weight: bold; font-size: 1.1em; margin-bottom: 15px; }
        .option { display: block; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; }
        .option:hover { background: #f0f0f0; }
        .selected { background: #e0e0e0; border-color: var(--primary); }
        button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 1em; }
        button:disabled { background: #ccc; }
        #recap { display: none; }
        .correct { color: green; font-weight: bold; }
        .wrong { color: red; font-weight: bold; }
        .explanation { font-style: italic; background: #fff3cd; padding: 10px; border-left: 4px solid #ffeeba; margin-top: 10px; }
        .match-item { display: flex; align-items: center; margin-bottom: 5px; }
        input[type="text"] { padding: 8px; width: 80%; }
    </style>
</head>
<body>

    <div id="setup-screen">
        <h1>Simulazione Esame Storia del Cinema</h1>
        <p>Corso(Unicatt)</p>
        <div class="card">
            <p>Il test prevede 30 domande estratte casualmente da un pool di 300. Ogni domanda vale 1 punto.</p>
            <button onclick="startQuiz()">Inizia Simulazione</button>
        </div>
    </div>

    <div id="quiz-container" style="display:none;">
        <div id="progress">Domanda 1 di 30</div>
        <div id="question-card" class="card"></div>
        <button id="next-btn" onclick="nextQuestion()">Prossima domanda</button>
    </div>

    <div id="recap">
        <h1>Risultato Finale</h1>
        <div id="score-display" class="card"></div>
        <div id="recap-list"></div>
        <button onclick="location.reload()">Riprova</button>
    </div>

    <script>
        let allQuestions = [];
        let selectedQuestions = [];
        let currentIdx = 0;
        let userAnswers = [];
        let score = 0;

        async function startQuiz() {
            try {
                const response = await fetch('questions.json');
                allQuestions = await response.json();
                selectedQuestions = allQuestions.sort(() => 0.5 - Math.random()).slice(0, 30);
                
                document.getElementById('setup-screen').style.display = 'none';
                document.getElementById('quiz-container').style.display = 'block';
                showQuestion();
            } catch (e) {
                alert("Errore nel caricamento delle domande. Assicurati che questions.json sia presente.");
            }
        }

        function showQuestion() {
            const q = selectedQuestions[currentIdx];
            const container = document.getElementById('question-card');
            document.getElementById('progress').innerText = `Domanda ${currentIdx + 1} di 30`;
            
            let html = `<div class="question-text">${q.question}</div>`;

            if (q.type === 'tf' || q.type === 'multiple') {
                q.options.forEach((opt, i) => {
                    html += `<div class="option" onclick="selectOption(${i}, this, ${q.type === 'multiple'})">${opt}</div>`;
                });
            } else if (q.type === 'fill') {
                html += `<input type="text" id="fill-input" placeholder="Scrivi qui la risposta...">`;
            } else if (q.type === 'match') {
                q.pairs.forEach((p, i) => {
                    html += `<div class="match-item">${p.a} âž” <input type="text" class="match-input" data-index="${i}" placeholder="Associa B"></div>`;
                });
            }

            container.innerHTML = html;
        }

        function selectOption(idx, el, isMultiple) {
            if (!isMultiple) {
                Array.from(el.parentNode.children).forEach(c => c.classList.remove('selected'));
            }
            el.classList.toggle('selected');
        }

        function nextQuestion() {
            saveAnswer();
            currentIdx++;
            if (currentIdx < 30) {
                showQuestion();
            } else {
                showRecap();
            }
        }

        function saveAnswer() {
            const q = selectedQuestions[currentIdx];
            let answer = null;

            if (q.type === 'tf' || q.type === 'multiple') {
                const selected = Array.from(document.querySelectorAll('.option.selected'));
                answer = selected.map(s => q.options.indexOf(s.innerText));
            } else if (q.type === 'fill') {
                answer = document.getElementById('fill-input').value.trim();
            } else if (q.type === 'match') {
                answer = Array.from(document.querySelectorAll('.match-input')).map(input => input.value.trim());
            }
            userAnswers.push(answer);
        }

        function calculateQuestionScore(q, userAns) {
            if (!userAns) return 0;
            if (q.type === 'tf') return userAns[0] === q.correct ? 1 : 0;
            if (q.type === 'multiple') {
                let correctCount = 0;
                q.correct.forEach(c => { if(userAns.includes(c)) correctCount++; });
                userAns.forEach(u => { if(!q.correct.includes(u)) correctCount -= 0.5; });
                return Math.max(0, correctCount / q.correct.length);
            }
            if (q.type === 'fill') return userAns.toLowerCase() === q.correct.toLowerCase() ? 1 : 0;
            if (q.type === 'match') {
                let matches = 0;
                q.pairs.forEach((p, i) => { if(userAns[i]?.toLowerCase() === p.b.toLowerCase()) matches++; });
                return matches / q.pairs.length;
            }
            return 0;
        }

        function showRecap() {
            document.getElementById('quiz-container').style.display = 'none';
            document.getElementById('recap').style.display = 'block';
            
            let totalScore = 0;
            let recapHtml = '';

            selectedQuestions.forEach((q, i) => {
                const qScore = calculateQuestionScore(q, userAnswers[i]);
                totalScore += qScore;
                
                recapHtml += `<div class="card">
                    <p><strong>${i+1}. ${q.question}</strong></p>
                    <p>Tua risposta: <span class="${qScore === 1 ? 'correct' : 'wrong'}">${JSON.stringify(userAnswers[i])}</span></p>
                    <p>Corretta: ${q.type === 'match' ? 'Vedi spiegazione' : q.correct}</p>
                    <div class="explanation"><strong>Correzione:</strong> ${q.explanation}</div>
                </div>`;
            });

            document.getElementById('score-display').innerHTML = `<h2>Punteggio: ${totalScore.toFixed(2)} / 30</h2>`;
            document.getElementById('recap-list').innerHTML = recapHtml;
        }
    </script>
</body>
</html>
